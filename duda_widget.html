<style>
/* âš™ï¸ ××™×§×•× ×•××¨××” ×”×‘×•×¢×” */
#ai-chat-bubble {
  position: fixed;
  bottom: 20px;
  left: 20px;             /* ×‘×¦×“ ×©×××œ */
  background: #004b8d;    /* ×¦×‘×¢ ×ª×•×× ××ª×¨ */
  color: #fff;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  z-index: 99999;
  transition: background 0.3s;
}
#ai-chat-bubble:hover {
  background: #0060c0;
}

/* âš™ï¸ ×—×œ×•× ×™×ª ×”×¦'××˜ */
#ai-fixed-chat {
  position: fixed;
  bottom: 90px;
  left: 20px; /* ×’× ×”×—×œ×•× ×™×ª ×‘×¦×“ ×©×××œ */
  width: 360px;
  max-width: 92vw;
  z-index: 99998;
  font-family: Arial, sans-serif;
  display: none; /* ××•×¡×ª×¨×ª ×¢×“ ×¤×ª×™×—×” */
}
#ai-fixed-chat .card {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  overflow: hidden;
  border: 1px solid #e6e6e6;
}
#ai-fixed-chat .header {
  background: #004b8d;
  color: #fff;
  padding: 12px 14px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#ai-fixed-chat .close-btn {
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
}
#ai-fixed-chat .msgs {
  max-height: 380px;
  overflow: auto;
  padding: 10px;
  direction: rtl;
  font-size: 14px;
}
#ai-fixed-chat .input-row {
  display: flex;
  border-top: 1px solid #eee;
}
#ai-fixed-chat input {
  flex: 1;
  border: 0;
  padding: 10px;
  font-size: 14px;
  direction: rtl;
  outline: none;
}
#ai-fixed-chat button {
  background: #004b8d;
  color: #fff;
  border: 0;
  padding: 10px 14px;
  cursor: pointer;
}
#ai-fixed-chat .msg {
  margin-bottom: 8px;
}
#ai-fixed-chat .msg .who {
  font-weight: 700;
  margin-left: 6px;
}
#ai-fixed-chat .source {
  font-size: 12px;
  color: #666;
  margin-top: 6px;
}
</style>

<!-- âš™ï¸ ×‘×•×¢×ª ×¤×ª×™×—×” -->
<div id="ai-chat-bubble" title="×©××œ ××ª ×¡×•×›×Ÿ ×”-AI">ğŸ’¬</div>

<!-- âš™ï¸ ×—×œ×•× ×™×ª ×”×¦'××˜ -->
<div id="ai-fixed-chat">
  <div class="card">
    <div class="header">
      ğŸ¤– ×¡×•×›×Ÿ AI â€” ×©××œ×•×ª × ×¤×•×¦×•×ª
      <span class="close-btn" onclick="toggleChat()">âœ–</span>
    </div>
    <div class="msgs" id="ai-msgs"></div>
    <div class="input-row">
      <input id="ai-input" placeholder="×©××œ/×™ ×©××œ×”..." />
      <button id="ai-send">×©×œ×—</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://ai-shabaton-1.onrender.com/query"; // ×›×ª×•×‘×ª ×”×©×¨×ª ×©×œ×š
const chatBubble = document.getElementById('ai-chat-bubble');
const chatWindow = document.getElementById('ai-fixed-chat');
const MSGS = document.getElementById('ai-msgs');
document.getElementById('ai-send').onclick = send;
document.getElementById('ai-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
chatBubble.onclick = toggleChat;

function toggleChat() {
  if (chatWindow.style.display === 'none' || chatWindow.style.display === '') {
    chatWindow.style.display = 'block';
  } else {
    chatWindow.style.display = 'none';
  }
}

function append(who, html){
  const el = document.createElement('div');
  el.className='msg';
  el.innerHTML = `<span class="who">${who}</span><div style="margin-top:4px;">${escapeHtml(html)}</div>`;
  MSGS.appendChild(el);
  MSGS.scrollTop = MSGS.scrollHeight;
  return el;
}
function escapeHtml(s){ 
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); 
}

async function send(){
  const inp = document.getElementById('ai-input');
  const q = inp.value.trim();
  if(!q) return;
  append('××ª×”', q);
  inp.value='';
  const loadingEl = append('×¡×•×›×Ÿ', '×‘×•×“×§ ×ª×©×•×‘×”, × × ×”××ª×Ÿ...');
  try {
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ query: q })
    });
    if(!res.ok){
      throw new Error('server error');
    }
    const data = await res.json();
    let srcHtml = '';
    if(data.sources && data.sources.length){
      srcHtml = '<div class="source">××§×•×¨×•×ª: ' + data.sources.map(s=>`<a href="${s}" target="_blank">${s}</a>`).join(' | ') + '</div>';
    }
    loadingEl.innerHTML = `<span class="who">×¡×•×›×Ÿ</span><div style="margin-top:4px;">${escapeHtml(data.answer)}</div>${srcHtml}`;
    MSGS.scrollTop = MSGS.scrollHeight;
  } catch(e){
    loadingEl.innerHTML = `<span class="who">×¡×•×›×Ÿ</span><div style="margin-top:4px;">××¦×˜×¢×¨×ª, ×—×œ×” ×©×’×™××” ×‘×©×¨×ª×™. ×× × × ×¡×• ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</div>`;
    console.error(e);
  }
}
</script>
