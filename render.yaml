services:
  - type: web
    name: ai-shabaton-1
    env: python
    region: frankfurt
    plan: free

    buildCommand: |
      echo "üöÄ Starting build process..."
      pip install -r requirements.txt

      # ◊™◊ê◊ô◊û◊ï◊™ ◊ë◊ô◊ü ◊í◊®◊°◊ê◊ï◊™
      pip install "chromadb>=0.5.5"
      pip install "openai>=1.0.0"

      # ◊ô◊¶◊ô◊®◊™ ◊™◊ô◊ß◊ô◊ï◊™ ◊ï◊ß◊ë◊¶◊ô◊ù ◊ë◊°◊ô◊°◊ô◊ô◊ù
      mkdir -p data/pages
      if [ ! -f data/pages/about.txt ]; then
        echo "◊¢◊û◊ï◊ì ◊ê◊ï◊ì◊ï◊™ ◊î◊ê◊™◊® ◊©◊ë◊™◊ï◊ü. ◊õ◊ê◊ü ◊™◊ï◊õ◊ú ◊ú◊û◊¶◊ï◊ê ◊û◊ô◊ì◊¢ ◊õ◊ú◊ú◊ô ◊¢◊ú ◊î◊ê◊™◊® ◊ï◊î◊©◊ô◊®◊ï◊™◊ô◊ù." > data/pages/about.txt
      fi
      if [ ! -f data/pages/faq.txt ]; then
        echo "◊©◊ê◊ú◊ï◊™ ◊ï◊™◊©◊ï◊ë◊ï◊™ ◊†◊§◊ï◊¶◊ï◊™ ◊¢◊ú ◊ê◊™◊® ◊©◊ë◊™◊ï◊ü ◊ï◊©◊ô◊®◊ï◊™◊ô◊ï." > data/pages/faq.txt
      fi
      if [ ! -f data/pages/contact.txt ]; then
        echo "◊¶◊ï◊® ◊ß◊©◊® ◊¢◊ù ◊¶◊ï◊ï◊™ ◊©◊ë◊™◊ï◊ü ◊ì◊®◊ö ◊ò◊ï◊§◊° ◊ë◊ê◊™◊® ◊ê◊ï ◊ë◊û◊ô◊ô◊ú info@shabaton.online" > data/pages/contact.txt
      fi

      echo "‚úÖ Created data/pages directory with default .txt files."

      # --- ◊ê◊ô◊†◊ì◊ï◊ß◊° ◊®◊ê◊©◊ï◊†◊ô ◊ë◊¢◊™ ◊ì◊ô◊§◊ú◊ï◊ô ---
      echo "üîß Running initial indexing..."
      python indexer.py > indexer_log.txt 2>&1 || echo "‚ö†Ô∏è indexer.py failed ‚Äî continuing deploy."
      echo "üìÑ --- Indexer Summary ---"
      grep -E "Indexed|complete|Skipped|files" indexer_log.txt || cat indexer_log.txt
      echo "üìÑ -----------------------"

      # ◊î◊ì◊§◊°◊™ ◊™◊ß◊¶◊ô◊® ◊ê◊ù ◊†◊ï◊¶◊®
      if [ -f data/index_summary.json ]; then
        echo "üóÇÔ∏è Indexed pages summary:"
        cat data/index_summary.json
      else
        echo "‚ö†Ô∏è No index_summary.json found ‚Äî skipping display."
      fi

      echo "‚úÖ Build completed successfully!"

    startCommand: "uvicorn main:app --host 0.0.0.0 --port 10000"

    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: CHROMA_DB_DIR
        value: /opt/render/project/src/data/index
      - key: EMBED_MODEL
        value: text-embedding-3-small
      - key: LLM_MODEL
        value: gpt-4o-mini
      - key: TOP_K
        value: "4"
      - key: BACKEND_ORIGIN
        value: "*"
      - key: MAX_CHUNK_TOKENS
        value: "800"

  # --- ◊ê◊ô◊†◊ì◊ï◊ß◊° ◊ê◊ï◊ò◊ï◊û◊ò◊ô ◊ô◊ï◊û◊ô ---
  - type: cron
    name: daily-indexer
    env: python
    schedule: "0 3 * * *"  # ◊õ◊ú ◊ô◊ï◊ù ◊ë◊©◊¢◊î 03:00
    region: frankfurt
    buildCommand: |
      echo "‚è∞ Starting daily re-index..."
      pip install -r requirements.txt
      python indexer.py > daily_index_log.txt 2>&1 || echo "‚ö†Ô∏è Daily indexer failed."
      echo "üìÑ Daily Indexer Summary:"
      grep -E "Indexed|complete|files" daily_index_log.txt || cat daily_index_log.txt
    envVars:
      - key: OPENAI_API_KEY
        sync: false
      - key: CHROMA_DB_DIR
        value: /opt/render/project/src/data/index
      - key: EMBED_MODEL
        value: text-embedding-3-small
      - key: MAX_CHUNK_TOKENS
        value: "800"
